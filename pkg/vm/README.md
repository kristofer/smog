# Smog Virtual Machine

The Smog Virtual Machine (VM) is a stack-based bytecode interpreter that executes compiled Smog programs.

## Overview

The VM is the runtime execution engine for Smog. It executes bytecode instructions generated by the compiler, manages the runtime stack, handles message dispatching, and maintains local and global variable state.

## Architecture

The VM follows a classic stack-based architecture with these key components:

- **Execution Stack**: A stack for operands and intermediate values (1024 slots)
- **Local Variables**: Storage for method-local variables (256 slots)
- **Global Variables**: Map for globally accessible variables
- **Constants Pool**: Read-only constant values referenced by bytecode
- **Instruction Pointer**: Points to the current instruction being executed

## Usage

### Creating a VM Instance

```go
import "github.com/kristofer/smog/pkg/vm"

// Create a new VM
vm := vm.New()
```

### Running Bytecode

```go
import (
    "github.com/kristofer/smog/pkg/bytecode"
    "github.com/kristofer/smog/pkg/compiler"
    "github.com/kristofer/smog/pkg/parser"
)

// Parse source code
p := parser.New("3 + 4")
program, err := p.Parse()

// Compile to bytecode
c := compiler.New()
bc, err := c.Compile(program)

// Execute on VM
vm := vm.New()
err = vm.Run(bc)

// Get the result from the stack
result := vm.StackTop()
fmt.Printf("Result: %v\n", result) // Output: Result: 7
```

### Accessing Results

The VM leaves the final result on top of the stack. Use `StackTop()` to retrieve it:

```go
result := vm.StackTop()
```

## Supported Operations

The VM currently supports:

### Arithmetic Operations
- Addition (`+`)
- Subtraction (`-`)
- Multiplication (`*`)
- Division (`/`)

### Comparison Operations
- Less than (`<`)
- Greater than (`>`)
- Less than or equal (`<=`)
- Greater than or equal (`>=`)
- Equal (`=`)
- Not equal (`~=`)

### I/O Operations
- `println` - Print value with newline
- `print` - Print value without newline

### Variable Operations
- Local variable load/store
- Global variable load/store

## Examples

### Simple Arithmetic

```go
// Parse and execute "10 + 5 * 2"
input := "10 + 5 * 2"
p := parser.New(input)
program, _ := p.Parse()

c := compiler.New()
bc, _ := c.Compile(program)

vm := vm.New()
vm.Run(bc)

fmt.Println(vm.StackTop()) // Output: 20
```

### Using Variables

```go
// Parse and execute variable assignment
input := `| x |
x := 42.
x + 10`

p := parser.New(input)
program, _ := p.Parse()

c := compiler.New()
bc, _ := c.Compile(program)

vm := vm.New()
vm.Run(bc)

fmt.Println(vm.StackTop()) // Output: 52
```

### Comparison Operations

```go
// Parse and execute comparison
input := "5 < 10"
p := parser.New(input)
program, _ := p.Parse()

c := compiler.New()
bc, _ := c.Compile(program)

vm := vm.New()
vm.Run(bc)

fmt.Println(vm.StackTop()) // Output: true
```

## Error Handling

The VM returns errors for:
- Stack overflow/underflow
- Invalid constant indices
- Invalid local variable indices
- Undefined global variables
- Division by zero
- Type mismatches in operations
- Unknown opcodes

Always check the error returned by `Run()`:

```go
err := vm.Run(bc)
if err != nil {
    fmt.Printf("VM error: %v\n", err)
}
```

## Implementation Details

- The VM uses Go's `interface{}` type for values to support dynamic typing
- Stack size is fixed at 1024 slots
- Local variables array is fixed at 256 slots
- Global variables use a map for dynamic storage
- Each `Run()` call resets the stack pointer to 0 and initializes all local variables to nil

## Related Documentation

- [VM Specification](SPECIFICATION.md) - Detailed technical specification
- [Bytecode Opcodes](../bytecode/bytecode.go) - Bytecode instruction set
- [Language Specification](../../docs/spec/LANGUAGE_SPEC.md) - Smog language reference
- [Architecture Overview](../../docs/design/ARCHITECTURE.md) - System architecture

## Maintenance Note

**Important**: As the Smog project evolves, this README should be kept up-to-date with:
- New opcodes and operations
- Changes to the VM architecture
- Updated usage examples
- New features and capabilities

When working on issues that modify the VM, consider creating an issue to update this documentation if the changes are not made as part of the current work.
